{% extends "base.html" %}

{% block content %}
<!-- Tab Navigation -->
<div class="mb-6 border-b border-gray-200">
    <div class="flex space-x-4">
        <button id="scrapeTab" class="tab-btn active-tab">Scrape Tool</button>
        <button id="mailTab" class="tab-btn inactive-tab">Mail to Lead</button>
        <button id="autoOfferTab" class="tab-btn inactive-tab">Auto-Offer</button>
        <button id="manualLeadTab" class="tab-btn inactive-tab">Manual Lead</button>
    </div>
</div>

<!-- Tab Content: Scrape Tool -->
<div id="scrapeContent" class="tab-content">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-8">
            <h1 class="text-2xl font-bold text-gray-900">AI Lead Generation Assistant</h1>
            <p class="mt-2 text-gray-600">Find leads from Google Maps, scrape their sites, and generate personalized outreach emails.</p>

            <form id="scrapeForm" action="/run_from_gmaps" method="post" class="mt-8 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <!-- Search & API Settings -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Search & API Settings</h2>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="query" class="block text-sm font-medium text-gray-700">Google Maps Query</label>
                            <input type="text" name="query" id="query" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Marketing agencies in New York">
                        </div>
                        <div>
                            <label for="api_key_scrape" class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                            <input type="password" name="api_key" id="api_key_scrape" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="sk-...">
                        </div>
                        <div>
                            <label for="max_results" class="block text-sm font-medium text-gray-700">Max Results (up to 50)</label>
                            <input type="number" name="max_results" id="max_results" value="5" min="1" max="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <!-- THIS FIELD WAS MISSING -->
                        <div>
                            <label for="gmail_api_key_scrape" class="block text-sm font-medium text-gray-700">Gmail API Key (Optional)</label>
                            <input type="password" name="gmail_api_key" id="gmail_api_key_scrape" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter key if used by backend">
                        </div>
                    </div>
                </div>
                <!-- Email Personalization -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Email Personalization</h2>
                    <div class="mt-4 space-y-4">
                       <div>
                            <label for="offer_scrape" class="block text-sm font-medium text-gray-700">Your Offer</label>
                            <textarea name="offer" id="offer_scrape" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Describe your service or product clearly."></textarea>
                        </div>
                        <div>
                            <label for="tone_scrape" class="block text-sm font-medium text-gray-700">Email Tone</label>
                            <input type="text" name="tone" id="tone_scrape" required value="Friendly and Personable" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                         <div>
                            <label for="additional_instructions_scrape" class="block text-sm font-medium text-gray-700">Additional Instructions (Optional)</label>
                            <textarea name="additional_instructions" id="additional_instructions_scrape" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Mention our recent award..."></textarea>
                        </div>
                        <div>
                            <label for="prompt_language_scrape" class="block text-sm font-medium text-gray-700">Prompt Language</label>
                             <select name="prompt_language" id="prompt_language_scrape" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="eng_prompt.txt">English</option>
                                <option value="ro_prompt.txt" selected>Romanian</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Submit Button -->
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Generate & Download JSON
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tab Content: Mail to Lead -->
<div id="mailContent" class="tab-content hidden">
     <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-8">
            <h1 class="text-2xl font-bold text-gray-900">Mail to Lead Tool</h1>
            <p class="mt-2 text-gray-600">Paste emails below to find their company websites and generate personalized outreach.</p>
            
            <form id="mailForm" action="/run_from_mail" method="post" enctype="multipart/form-data" class="mt-8 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                
                <!-- Input Section -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Input & API Key</h2>
                     <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="emails" class="block text-sm font-medium text-gray-700">Email List (one per line)</label>
                            <input type="file" name="email_file" id="email_file" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="api_key_mail" class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                            <input type="password" name="api_key" id="api_key_mail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="sk-...">
                        </div>
                        <!-- THIS FIELD WAS MISSING -->
                        <div>
                            <label for="gmail_api_key_mail" class="block text-sm font-medium text-gray-700">Gmail API Key (Optional)</label>
                            <input type="password" name="gmail_api_key" id="gmail_api_key_mail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Enter key if used by backend">
                        </div>
                    </div>
                </div>

                <!-- Email Personalization (Shared) -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Email Personalization</h2>
                    <div class="mt-4 space-y-4">
                       <div>
                            <label for="offer_mail" class="block text-sm font-medium text-gray-700">Your Offer</label>
                            <textarea name="offer" id="offer_mail" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Describe your service or product clearly."></textarea>
                        </div>
                        <div>
                            <label for="tone_mail" class="block text-sm font-medium text-gray-700">Email Tone</label>
                            <input type="text" name="tone" id="tone_mail" required value="Friendly and approachable" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                         <div>
                            <label for="additional_instructions_mail" class="block text-sm font-medium text-gray-700">Additional Instructions (Optional)</label>
                            <textarea name="additional_instructions" id="additional_instructions_mail" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Mention our recent award..."></textarea>
                        </div>
                        <div>
                            <label for="prompt_language_mail" class="block text-sm font-medium text-gray-700">Prompt Language</label>
                             <select name="prompt_language" id="prompt_language_mail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="eng_prompt.txt">English</option>
                                <option value="ro_prompt.txt" selected>Romanian</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Find Websites & Generate Emails
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="autoOfferContent" class="tab-content hidden">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-8">
            <h1 class="text-2xl font-bold text-gray-900">Auto-Offer Generator</h1>
            <p class="mt-2 text-gray-600">Paste a companyâ€™s website URL and automatically generate a professional offer summary.</p>

            <form id="autoOfferForm" action="/auto_offer" method="post" class="mt-8 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Website & API Key</h2>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="url" class="block text-sm font-medium text-gray-700">Website URL</label>
                            <input type="url" name="url" id="url" required
                                placeholder="https://example.com"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="api_key_auto" class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                            <input type="password" name="api_key" id="api_key_auto" required
                                placeholder="sk-..."
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="additional_info" class="block text-sm font-medium text-gray-700">Additional Info (Optional)</label>
                    <textarea name="additional_info" id="additional_info" rows="3"
                        placeholder="Add any context or details you'd like included..."
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
                </div>

                <div>
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Generate Offer Summary
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tab Content: Manual Lead -->
<div id="manualLeadContent" class="tab-content hidden">
    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">
        <div class="p-8">
            <h1 class="text-2xl font-bold text-gray-900">Create Manual Lead</h1>
            <p class="mt-2 text-gray-600">Manually create a lead for testing or for cases where automatic scraping is not possible.</p>

            <form id="manualLeadForm" action="/manual_lead" method="post" class="mt-8 space-y-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Lead Details</h2>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="company_name" class="block text-sm font-medium text-gray-700">Company Name</label>
                            <input type="text" name="company_name" id="company_name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Acme Inc.">
                        </div>
                        <div>
                            <label for="contact_email" class="block text-sm font-medium text-gray-700">Contact Email</label>
                            <input type="email" name="contact_email" id="contact_email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., contact@acme.com">
                        </div>
                        <div class="md:col-span-2">
                            <label for="website_url" class="block text-sm font-medium text-gray-700">Website URL</label>
                            <input type="url" name="website_url" id="website_url" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="https://www.acme.com">
                        </div>
                    </div>
                </div>
                <!-- Email Personalization -->
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">Email Personalization</h2>
                    <div class="mt-4 space-y-4">
                       <div>
                            <label for="offer_manual" class="block text-sm font-medium text-gray-700">Your Offer</label>
                            <textarea name="offer" id="offer_manual" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Describe your service or product clearly."></textarea>
                        </div>
                        <div>
                            <label for="tone_manual" class="block text-sm font-medium text-gray-700">Email Tone</label>
                            <input type="text" name="tone" id="tone_manual" required value="Friendly and Personable" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                         <div>
                            <label for="additional_instructions_manual" class="block text-sm font-medium text-gray-700">Additional Instructions (Optional)</label>
                            <textarea name="additional_instructions" id="additional_instructions_manual" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., Mention our recent award..."></textarea>
                        </div>
                        <div>
                            <label for="prompt_language_manual" class="block text-sm font-medium text-gray-700">Prompt Language</label>
                             <select name="prompt_language" id="prompt_language_manual" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="eng_prompt.txt">English</option>
                                <option value="ro_prompt.txt" selected>Romanian</option>
                            </select>
                        </div>
                        <div>
                            <label for="api_key_manual" class="block text-sm font-medium text-gray-700">OpenAI API Key</label>
                            <input type="password" name="api_key" id="api_key_manual" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="sk-...">
                        </div>
                    </div>
                </div>
                <!-- Submit Button -->
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Create Lead and Generate Email
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Tab Switching Logic ---
    const scrapeTab = document.getElementById('scrapeTab');
    const mailTab = document.getElementById('mailTab');
    const autoOfferTab = document.getElementById('autoOfferTab');
    const manualLeadTab = document.getElementById('manualLeadTab');
    const scrapeContent = document.getElementById('scrapeContent');
    const mailContent = document.getElementById('mailContent');
    const autoOfferContent = document.getElementById('autoOfferContent');
    const manualLeadContent = document.getElementById('manualLeadContent');
    const tabs = [scrapeTab, mailTab, autoOfferTab, manualLeadTab];

    function switchTabs(activeTab) {
        tabs.forEach(tab => {
            const isActive = tab === activeTab;
            tab.classList.toggle('active-tab', isActive);
            tab.classList.toggle('inactive-tab', !isActive);
        });
        scrapeContent.classList.toggle('hidden', activeTab !== scrapeTab);
        mailContent.classList.toggle('hidden', activeTab !== mailTab);
        autoOfferContent.classList.toggle('hidden', activeTab !== autoOfferTab);
        manualLeadContent.classList.toggle('hidden', activeTab !== manualLeadTab);
    }

    scrapeTab.addEventListener('click', () => switchTabs(scrapeTab));
    mailTab.addEventListener('click', () => switchTabs(mailTab));
    autoOfferTab.addEventListener('click', () => switchTabs(autoOfferTab));
    manualLeadTab.addEventListener('click', () => switchTabs(manualLeadTab));
    switchTabs(scrapeTab); // Set default

    // --- Form Submission & Status Logic ---
    const statusOverlay = document.getElementById('statusOverlay');
    const statusText = document.getElementById('statusText');
    const scrapeForm = document.getElementById('scrapeForm');
    const mailForm = document.getElementById('mailForm');
    const autoOfferForm = document.getElementById('autoOfferForm');
    const manualLeadForm = document.getElementById('manualLeadForm');

    async function handleFormSubmit(event, form, statusLogic) {
        event.preventDefault();
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        statusLogic();

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: form.method,
                body: formData,
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Server error: ${response.status}`);
            }
            
            if (form.action.includes('auto_offer')) {
                const data = await response.json();
                displayOfferResult(data);
                statusOverlay.classList.add('hidden');
            } else {
                window.location.href = "{{ url_for('main.tasks') }}";
            }

        } catch (error) {
            statusText.textContent = `Error: ${error.message}`;
            setTimeout(() => {
                statusOverlay.classList.add('hidden');
                statusText.textContent = 'Processing your request...'; // Reset text
            }, 3000);
        }
    }

    function runScrapeStatus() {
        statusText.textContent = 'Starting task... This may take a few minutes.';
        statusOverlay.classList.remove('hidden');
    }

    function runMailStatus() {
        statusText.textContent = 'Starting task... This may take a few minutes.';
        statusOverlay.classList.remove('hidden');
    }

    function runAutoOfferStatus() {
        statusText.textContent = 'Scraping website and generating offer...';
        statusOverlay.classList.remove('hidden');
    }

    scrapeForm.addEventListener('submit', (e) => handleFormSubmit(e, scrapeForm, runScrapeStatus));
    mailForm.addEventListener('submit', (e) => handleFormSubmit(e, mailForm, runMailStatus));
    autoOfferForm.addEventListener('submit', (e) => handleFormSubmit(e, autoOfferForm, runAutoOfferStatus));
    manualLeadForm.addEventListener('submit', (e) => handleFormSubmit(e, manualLeadForm, runManualLeadStatus));

    function runManualLeadStatus() {
        statusText.textContent = 'Creating lead and generating email...';
        statusOverlay.classList.remove('hidden');
    }

    function displayOfferResult(data) {
        const oldResult = document.getElementById('offerResult');
        if (oldResult) oldResult.remove();

        const resultDiv = document.createElement('div');
        resultDiv.id = 'offerResult';
        resultDiv.className = "mt-6 p-6 bg-white shadow rounded-lg border border-gray-200";

        resultDiv.innerHTML = `
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Generated Offer Summary</h3>
            <p class="text-sm text-indigo-600 mb-4">${data.website}</p>
            <pre id="offerText" class="whitespace-pre-wrap text-gray-700 text-sm">${data.summary}</pre>
            <button id="copyOfferBtn" class="mt-4 text-sm px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                Copy Offer
            </button>
        `;

        autoOfferForm.parentNode.appendChild(resultDiv);

        document.getElementById('copyOfferBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('offerText').innerText);
            const btn = document.getElementById('copyOfferBtn');
            btn.textContent = 'Copied!';
            setTimeout(() => { btn.textContent = 'Copy Offer'; }, 2000);
        });
    }
</script>
{% endblock %}